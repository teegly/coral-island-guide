<app-list-detail-container>
    @if (selectedEntity) {
        <app-item-card-switch [item]="selectedEntity" listDetail>
            <ng-template let-details appDatabaseItemDetails>
                <app-offering [details]="details"/>
            </ng-template>
        </app-item-card-switch>
    }

    @if (npc) {

        <app-card>
            <div class="text-2xl text-black font-semibold flex items-center gifting-portrait">
                <app-item-icon class="h-16 mr-3"
                               [itemName]="npc.iconName"/>
                <div class="flex flex-col">
                    <div class="flex gap-2 items-center"> {{ npc.characterName }}
                        @if (npc.isDateable) {
                            <app-ui-icon
                                    [uiIcon]="uiIcon.LOVE" class="!text-gifting !h-6 !w-6"
                                    matTooltip="{{npc.characterName}} is dateable"/>
                        }
                    </div>
                    @if (npc.birthday) {
                        <div
                                class="text-lg flex gap-2">
                            <app-ui-icon [uiIcon]="uiIcon.BIRTHDAY" class="!h-6 !w-6"/>
                            {{ npc.birthday | ingameDate }}
                        </div>
                    }
                </div>


            </div>
            @if (npc.description) {
                <p class="mt-2">{{ npc.description }}</p>
            }
            
            @if (npc.canHaveRelationships) {
                <div class="mt-4 flex flex-col gap-2">
                    <div class="text-lg font-semibold text-black">Heart Level</div>
                    <div class="flex items-center gap-3">
                        <button 
                            (click)="decrementHeartLevel()"
                            class="bg-[#F1E1CC] hover:bg-[#F2DBB7] rounded-full w-8 h-8 flex items-center justify-center text-black font-bold text-xl leading-none"
                            [disabled]="getHeartLevel() === 0"
                            matTooltip="Decrease heart level">
                            âˆ’
                        </button>
                        <div class="grid grid-cols-5 gap-1.5">
                            @for (heart of [1,2,3,4,5,6,7,8,9,10]; track heart) {
                                <app-ui-icon 
                                    [uiIcon]="uiIcon.LOVE" 
                                    [ngClass]="getHeartLevel() >= heart ? 'filled-heart' : 'empty-heart'"
                                    [matTooltip]="heart + ' heart(s)'"/>
                            }
                        </div>
                        <button 
                            (click)="incrementHeartLevel()"
                            class="bg-[#F1E1CC] hover:bg-[#F2DBB7] rounded-full w-8 h-8 flex items-center justify-center text-black font-bold text-xl leading-none"
                            [disabled]="getHeartLevel() === 10"
                            matTooltip="Increase heart level">
                            +
                        </button>
                    </div>
                </div>
            }
        </app-card>


        <app-card class="mt-6">
            <h2 class="mb-4 font-semibold text-2xl text-black">
                Gifting
            </h2>
            @if (giftingPreferences) {
                <app-gifting-grid [preferences]="giftingPreferences" (itemClicked)="showDetails($event)"/>
            }
            @if (!giftingPreferences) {
                <p class="text-black text-lg">
                    {{ npc.characterName }} has no specialized preferences.
                </p>
            }
        </app-card>

        <app-card class="mt-6">
            <h2 class="mb-4 font-semibold text-2xl text-black">
                Heart events
            </h2>
            @if (heartEvents.length) {
                <app-heart-events [heartEvents]="heartEvents"/>
            }
            @if (!heartEvents.length) {
                <p class="text-black text-lg">
                    {{ npc.characterName }} has no heart events.
                </p>
            }
        </app-card>

        <app-card class="mt-6">
            <h2 class="mb-4 font-semibold text-2xl text-black">
                Appearances
            </h2>

            @for (appearances of npc.appearances; track appearances) {

                @if (appearances.appearanceCategory) {
                    <h3 class="mb-4 font-semibold text-xl text-black">
                        {{ appearances.appearanceCategory }}
                    </h3>
                }

                @if ((appearances.appearances | keyvalue: null); as appearancePairs) {

                    @if (appearancePairs.length) {

                        @for (appearancePair of appearancePairs; track appearancePair) {
                            <div class="font-semibold text-black mb-6">
                                <h4 class="text-lg">{{ appearancePair.key }}</h4>
                                <div class="grid portrait-grid gap-4">
                                    @for (emotionPair of (appearancePair.value | keyvalue); track emotionPair) {
                                        <div class="flex flex-col shadow-lg p-2 relative group">
                                            <a href="assets/{{environment}}/portraits/{{npc.key}}/{{emotionPair.value}}.webp?v={{version}}"
                                               target="_blank"
                                               class="hidden group-focus-visible:block group-hover:block absolute top-2.5 right-2.5">
                                                <app-ui-icon [uiIcon]="UiIcon.MAGNIFYING_GLASS"/>
                                            </a>
                                            <app-npc-portrait [npcKey]="npc.key" [portraitName]="emotionPair.value"
                                                              class="h-[400px] flex items-end justify-center"/>
                                            <span class="">{{ emotionPair.key }}</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                    }

                    @if (!appearancePairs.length) {
                        <p class="text-black text-lg">
                            {{ npc.characterName }} has no appearances.
                        </p>
                    }


                }


            }
        </app-card>

    } @else if (npc === undefined) {

        <app-card>
            <h1 class="mb-4 font-semibold text-3xl text-black flex items-center gap-x-4 ">
                NPC not found.
            </h1>
        </app-card>

    } @else if (npc === null) {
        <mat-spinner class="mx-auto text-white"/>
    }
</app-list-detail-container>
